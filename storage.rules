rules_version = '2';

// Craft rules based on data in your Firestore database
// allow write: if firestore.get(
//    /databases/(default)/documents/users/$(request.auth.uid)).data.isAdmin == true
service firebase.storage {
  match /b/{bucket}/o {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Admin check based on users collection in Firestore
    function isAdmin() {
      return isAuthenticated() && 
             firestore.exists(/databases/(default)/documents/users/$(request.auth.uid)) &&
             firestore.get(/databases/(default)/documents/users/$(request.auth.uid)).data.role == 'admin' &&
             firestore.get(/databases/(default)/documents/users/$(request.auth.uid)).data.isActive == true;
    }
    
    // Validate image file types and sizes
    function isValidImage() {
      return request.resource.contentType.matches('image/.*') &&
             request.resource.size < 5 * 1024 * 1024; // 5MB limit
    }
    
    // Validate document file types and sizes
    function isValidDocument() {
      return (request.resource.contentType.matches('image/.*') || 
              request.resource.contentType == 'application/pdf') &&
             request.resource.size < 10 * 1024 * 1024; // 10MB limit
    }
    
    // Student profile images
    match /student-profiles/{allPaths=**} {
      allow read: if isAdmin(); // Only admins can view student profiles
      allow write: if isAdmin() && isValidImage(); // Only admins can upload valid images
      allow delete: if isAdmin(); // Only admins can delete student profiles
    }
    
    // Student signatures
    match /student-signatures/{allPaths=**} {
      allow read: if isAdmin(); // Only admins can view signatures
      allow write: if isAdmin() && isValidImage(); // Only admins can upload valid signature images
      allow delete: if isAdmin(); // Only admins can delete signatures
    }
    
    // Student marksheets
    match /student-marksheets/{allPaths=**} {
      allow read: if isAdmin(); // Only admins can view marksheets
      allow write: if isAdmin() && isValidDocument(); // Only admins can upload valid documents
      allow delete: if isAdmin(); // Only admins can delete marksheets
    }
    
    // Application documents from public submissions
    match /applications/{folder}/{allPaths=**} {
      allow read: if isAdmin(); // Only admins can view application documents
      allow write: if isValidDocument(); // Allow public uploads with validation
      allow delete: if isAdmin(); // Only admins can delete application documents
    }
    
    // Specific rules for application profile images
    match /applications/profiles/{allPaths=**} {
      allow read: if isAdmin();
      allow write: if isValidImage(); // Profile images must be valid images
      allow delete: if isAdmin();
    }
    
    // Specific rules for application signatures
    match /applications/signatures/{allPaths=**} {
      allow read: if isAdmin();
      allow write: if isValidImage(); // Signatures must be valid images
      allow delete: if isAdmin();
    }
    
    // Specific rules for application marksheets
    match /applications/marksheets/{allPaths=**} {
      allow read: if isAdmin();
      allow write: if isValidDocument(); // Marksheets can be images or PDFs
      allow delete: if isAdmin();
    }
    
    // Hero images for website
    match /hero-images/{allPaths=**} {
      allow read: if true; // Public read access
      allow write, delete: if isAuthenticated();
    }
    
    // Book covers and related images
    match /book-images/{allPaths=**} {
      allow read: if isAuthenticated();
      allow write, delete: if isAuthenticated();
    }
    
    // Member photos
    match /member-photos/{allPaths=**} {
      allow read: if isAuthenticated();
      allow write, delete: if isAuthenticated();
    }
    
    // News and event images
    match /news-images/{allPaths=**} {
      allow read: if true; // Public read access
      allow write, delete: if isAuthenticated();
    }
    
    match /event-images/{allPaths=**} {
      allow read: if true; // Public read access
      allow write, delete: if isAuthenticated();
    }
    
    // Gallery/media images
    match /gallery/{allPaths=**} {
      allow read: if true; // Public read access
      allow write, delete: if isAuthenticated();
    }
    
    // Media management uploads (photos, gallery, news images)
    match /media/{allPaths=**} {
      allow read: if true; // Public read access for website gallery display
      allow write: if isAdmin() && isValidImage(); // Only admins can upload media with validation
      allow delete: if isAdmin(); // Only admins can delete media files
    }
    
    // Website assets (logos, favicons, etc.)
    match /website-assets/{allPaths=**} {
      allow read: if true; // Public read access for website display
      allow write: if isAdmin() && isValidImage(); // Only admins can upload website assets
      allow delete: if isAdmin(); // Only admins can delete website assets
    }
    
    // Organization logos and branding
    match /branding/{allPaths=**} {
      allow read: if true; // Public read access
      allow write: if isAdmin() && isValidImage(); // Only admins can manage branding
      allow delete: if isAdmin();
    }
    
    // Settings-related uploads
    match /settings/{allPaths=**} {
      allow read: if true; // Public read access for website display
      allow write: if isAdmin() && isValidImage(); // Only admins can upload settings images
      allow delete: if isAdmin(); // Only admins can delete settings images
    }
    
    // Documents and files
    match /documents/{allPaths=**} {
      allow read: if isAuthenticated();
      allow write, delete: if isAuthenticated();
    }
    
    // Default rule for any other paths
    match /{allPaths=**} {
      allow read, write: if isAuthenticated();
    }
  }
}