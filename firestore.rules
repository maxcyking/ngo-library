rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // DEVELOPMENT RULES - More permissive for testing
    // TODO: Replace with production rules before going live
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Admin check based on users collection
    function isAdmin() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isActive == true;
    }
    
    // Validate application data structure
    function isValidApplication(data) {
      return data.keys().hasAll(['name', 'fatherHusbandName', 'phone', 'applicationType', 'status']) &&
             data.name is string && data.name.size() > 0 &&
             data.fatherHusbandName is string && data.fatherHusbandName.size() > 0 &&
             data.phone is string && data.phone.size() > 0 &&
             data.applicationType in ['library', 'member'] &&
             data.status in ['pending', 'approved', 'rejected'];
    }
    
    // Validate student data structure
    function isValidStudent(data) {
      return data.keys().hasAll(['name', 'fatherHusbandName', 'phone', 'status']) &&
             data.name is string && data.name.size() > 0 &&
             data.fatherHusbandName is string && data.fatherHusbandName.size() > 0 &&
             data.phone is string && data.phone.size() > 0 &&
             data.status in ['active', 'inactive', 'suspended'];
    }
    
    // Users collection
    match /users/{userId} {
      allow read, write, create, delete: if isAuthenticated();
    }
    
    // Students collection - Main collection for student management
    match /students/{studentId} {
      allow read, list: if isAdmin(); // Only admins can view student records
      allow create: if isAdmin() && isValidStudent(request.resource.data); // Only admins can create valid students
      allow update: if isAdmin() && isValidStudent(request.resource.data); // Only admins can update with valid data
      allow delete: if isAdmin(); // Only admins can delete students
    }
    
    // Library applications collection - Public applications from website
    match /library-applications/{applicationId} {
      allow create: if isValidApplication(request.resource.data) && 
                       request.resource.data.status == 'pending'; // Anyone can submit valid applications with pending status
      allow read, list: if isAdmin(); // Only admins can view applications
      allow update: if isAdmin() && 
                       isValidApplication(request.resource.data); // Only admins can update with valid data
      allow delete: if isAdmin(); // Only admins can delete applications
    }
    
    // Hero images for UI management
    match /heroImages/{imageId} {
      allow read: if true; // Public read access for website display
      allow write, create, delete, list: if isAuthenticated();
    }
    
    // UI content management
    match /uiContent/{contentId} {
      allow read: if true; // Public read access for website display
      allow write, create, delete, list: if isAuthenticated();
    }
    
    // Books collection
    match /books/{bookId} {
      allow read: if true; // Public read access for library browsing
      allow write, create, delete, list: if isAuthenticated();
    }
    
    // Book transactions collection
    match /bookTransactions/{transactionId} {
      allow read, list: if isAdmin(); // Only admins can view book transactions
      allow write, create, delete: if isAdmin(); // Only admins can manage book transactions
    }
    
    // Events collection
    match /events/{eventId} {
      allow read: if true; // Public read access for event browsing
      allow write, create, delete, list: if isAdmin();
    }
    
    // Event registrations collection
    match /eventRegistrations/{registrationId} {
      allow read, write, create, delete, list: if isAuthenticated();
    }
    
    // Members collection
    match /members/{memberId} {
      allow read, list: if isAdmin(); // Only admins can view member records
      allow write, create, delete: if isAdmin(); // Only admins can manage members
    }
    
    // Library transactions
    match /transactions/{transactionId} {
      allow read, list: if isAdmin(); // Only admins can view transactions
      allow write, create, delete: if isAdmin(); // Only admins can manage transactions
    }
    
    // News articles collection
    match /newsArticles/{articleId} {
      allow read: if true; // Public read access for website display
      allow write, create, delete, list: if isAdmin(); // Only admins can manage news
    }
    
    // News categories collection
    match /newsCategories/{categoryId} {
      allow read: if true; // Public read access
      allow write, create, delete, list: if isAdmin(); // Only admins can manage categories
    }
    
    // News tags collection
    match /newsTags/{tagId} {
      allow read: if true; // Public read access
      allow write, create, delete, list: if isAdmin(); // Only admins can manage tags
    }
    
    
    // Media/Gallery
    match /media/{mediaId} {
      allow read: if true; // Public read access
      allow write, create, delete, list: if isAuthenticated();
    }
    
    // Contact forms and inquiries
    match /inquiries/{inquiryId} {
      allow create: if true; // Anyone can submit inquiries
      allow read, list: if isAdmin(); // Only admins can view inquiries
      allow update, delete: if isAdmin(); // Only admins can manage inquiries
    }
    
    // Donations data
    match /donations/{donationId} {
      allow read: if true; // Public read for transparency
      allow write, create, delete, list: if isAuthenticated();
    }
    
    // Blood donors
    match /bloodDonors/{donorId} {
      allow read: if true; // Public read for emergency access
      allow write, create, delete, list: if isAuthenticated();
    }
    
    // Body donors
    match /bodyDonors/{donorId} {
      allow read, write, create, delete, list: if isAuthenticated();
    }
    
    // Financial donors
    match /financialDonors/{donorId} {
      allow read: if true; // Public read for transparency
      allow write, create, delete, list: if isAuthenticated();
    }
    
    // System settings and configuration
    match /settings/{settingId} {
      allow read: if isAdmin(); // Only admins can read settings
      allow write, create, delete, list: if isAdmin(); // Only admins can manage settings
    }
    
    // Audit logs
    match /auditLogs/{logId} {
      allow read, list: if isAdmin(); // Only admins can read audit logs
      allow create: if isAuthenticated(); // Authenticated users can create logs
      allow update, delete: if false; // Audit logs should not be modified or deleted
    }
  }
}