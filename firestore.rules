rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user is admin
    function isAdmin() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isActive == true;
    }
    
    // Helper function to check if user is active
    function isActiveUser() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isActive == true;
    }
    
    // Users collection - only admins can read/write user data
    match /users/{userId} {
      allow read: if isAdmin() || (isAuthenticated() && request.auth.uid == userId);
      allow write: if isAdmin();
      allow create: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // Books collection
    match /books/{bookId} {
      allow read: if isActiveUser();
      allow write, create, delete: if isAdmin();
    }
    
    // Members collection
    match /members/{memberId} {
      allow read: if isActiveUser();
      allow write, create, delete: if isAdmin();
    }
    
    // Library transactions
    match /transactions/{transactionId} {
      allow read: if isActiveUser();
      allow write, create: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // News and content
    match /news/{newsId} {
      allow read: if true; // Public read access
      allow write, create, delete: if isAdmin();
    }
    
    // Events
    match /events/{eventId} {
      allow read: if true; // Public read access
      allow write, create, delete: if isAdmin();
    }
    
    // Media/Gallery
    match /media/{mediaId} {
      allow read: if true; // Public read access
      allow write, create, delete: if isAdmin();
    }
    
    // Contact forms and inquiries
    match /inquiries/{inquiryId} {
      allow read: if isAdmin();
      allow create: if true; // Anyone can submit inquiries
      allow update, delete: if isAdmin();
    }
    
    // Donations data
    match /donations/{donationId} {
      allow read: if true; // Public read for transparency
      allow write, create, delete: if isAdmin();
    }
    
    // Blood donors
    match /bloodDonors/{donorId} {
      allow read: if true; // Public read for emergency access
      allow write, create, delete: if isAdmin();
    }
    
    // Body donors
    match /bodyDonors/{donorId} {
      allow read: if isAdmin();
      allow write, create, delete: if isAdmin();
    }
    
    // Financial donors
    match /financialDonors/{donorId} {
      allow read: if true; // Public read for transparency
      allow write, create, delete: if isAdmin();
    }
    
    // System settings and configuration
    match /settings/{settingId} {
      allow read: if isAdmin();
      allow write, create, delete: if isAdmin();
    }
    
    // Audit logs
    match /auditLogs/{logId} {
      allow read: if isAdmin();
      allow create: if isAuthenticated();
      allow update, delete: if false; // Logs should not be modified
    }
  }
}