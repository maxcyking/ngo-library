rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // PRODUCTION RULES - Secure and role-based
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user is admin
    function isAdmin() {
      return isAuthenticated() && 
             (request.auth.token.email == 'admin@arogyabmr.org' ||
              (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
               get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' &&
               get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isActive == true));
    }
    
    // Helper function to check if user is active member
    function isActiveMember() {
      return isAuthenticated() && 
             (isAdmin() ||
              (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
               get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isActive == true));
    }
    
    // Users collection - Admin only for management
    match /users/{userId} {
      allow read: if isAdmin() || (isAuthenticated() && request.auth.uid == userId);
      allow write, create, delete: if isAdmin();
    }
    
    // Students collection - Admin only for management
    match /students/{studentId} {
      allow read: if isActiveMember();
      allow write, create, delete, list: if isAdmin();
    }
    
    // Hero images for UI management - Admin only for management
    match /heroImages/{imageId} {
      allow read: if true; // Public read access for website display
      allow write, create, delete, list: if isAdmin();
    }
    
    // UI content management - Admin only for management
    match /uiContent/{contentId} {
      allow read: if true; // Public read access for website display
      allow write, create, delete, list: if isAdmin();
    }
    
    // Books collection - Members can read, Admin can manage
    match /books/{bookId} {
      allow read: if isActiveMember();
      allow write, create, delete, list: if isAdmin();
    }
    
    // Members collection - Members can read own data, Admin can manage all
    match /members/{memberId} {
      allow read: if isActiveMember();
      allow write, create, delete, list: if isAdmin();
    }
    
    // Library transactions - Members can read own, Admin can manage all
    match /transactions/{transactionId} {
      allow read: if isActiveMember();
      allow write, create, delete, list: if isAdmin();
    }
    
    // News and content - Public read, Admin manage
    match /news/{newsId} {
      allow read: if true; // Public read access
      allow write, create, delete, list: if isAdmin();
    }
    
    // Events - Public read, Admin manage
    match /events/{eventId} {
      allow read: if true; // Public read access
      allow write, create, delete, list: if isAdmin();
    }
    
    // Media/Gallery - Public read, Admin manage
    match /media/{mediaId} {
      allow read: if true; // Public read access
      allow write, create, delete, list: if isAdmin();
    }
    
    // Contact forms and inquiries - Anyone can create, Admin can manage
    match /inquiries/{inquiryId} {
      allow read, write, delete, list: if isAdmin();
      allow create: if true; // Anyone can submit inquiries
    }
    
    // Donations data - Public read for transparency, Admin manage
    match /donations/{donationId} {
      allow read: if true; // Public read for transparency
      allow write, create, delete, list: if isAdmin();
    }
    
    // Blood donors - Public read for emergency access, Admin manage
    match /bloodDonors/{donorId} {
      allow read: if true; // Public read for emergency access
      allow write, create, delete, list: if isAdmin();
    }
    
    // Body donors - Admin only (sensitive data)
    match /bodyDonors/{donorId} {
      allow read, write, create, delete, list: if isAdmin();
    }
    
    // Financial donors - Public read for transparency, Admin manage
    match /financialDonors/{donorId} {
      allow read: if true; // Public read for transparency
      allow write, create, delete, list: if isAdmin();
    }
    
    // System settings and configuration - Admin only
    match /settings/{settingId} {
      allow read, write, create, delete, list: if isAdmin();
    }
    
    // Audit logs - Admin only, no deletion allowed
    match /auditLogs/{logId} {
      allow read, list: if isAdmin();
      allow create: if isAuthenticated();
      allow write, delete: if false; // Logs should not be modified or deleted
    }
  }
}